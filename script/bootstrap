#!/bin/bash

mkdir $HOME/log
exec > >(tee -i $HOME/log/dotfiles_install.log)
exec 2>&1
set -x

## codespaces-specific
if ! [ -z $CODESPACES ]; then
		echo "INFO: Setup for codespaces."

		## remove codespaces built-ins
		rm -f $HOME/.zshrc

		## setup
		mkdir $HOME/.config/nvim

		## link the things
		ln -sf $(pwd)/.zshrc $HOME/.zshrc
		ln -sf $(pwd)/.aliases $HOME/.aliases
		ln -sf $(pwd)/.gitconfig $HOME/.gitconfig
		ln -sf $(pwd)/.config/nvim/* $HOME/.config/nvim/

		## change to zsh
		sudo chsh -s "$(which zsh)" "$(whoami)"
fi

## rbenv
if [ -z "$(which rbenv)" ]; then
		echo "INFO: Install rbenv."
		
		sudo apt install -y rbenv
		mkdir -p "$(rbenv root)"/plugins
		git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build
		rbenv install 3.1.0 &>/dev/null &
fi

## neovim
if [ -z "$(which nvim)" ]; then
		echo "INFO: Install neovim."

		curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
		chmod u+x nvim.appimage
		./nvim.appimage --appimage-extract
		sudo mv squashfs-root /usr/local/squashfs-nvim
		sudo ln -s /usr/local/squashfs-nvim/AppRun /usr/local/bin/nvim

		### install vim-plug
		sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
				https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'

		### install plugins
		nvim --headless +PlugInstall +qa
fi

## zsh
if [ -z $(which zsh) ]; then
		sudo apt install -y zsh
fi

if [[ $SHELL != *"zsh"* ]]; then
		echo "Changing shell to zsh."
		chsh -s "$(which zsh)"
fi

