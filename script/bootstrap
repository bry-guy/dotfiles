#!/bin/bash

# Log dotfiles setup
mkdir $HOME/log
exec > >(tee -i $HOME/log/dotfiles_install.log)
exec 2>&1

set -x

## detect OS
case $(uname -s) in
  Darwin)
    OS_MAC=1 
    ;;

  Linux)
    OS_LINUX=1
    ;;

  *)
    echo "Unknown operating system."
	exit 1
	;;
esac

## detect architecture
case $(uname -m) in
  arm64)
    ARCH_ARM=1 
    ;;

  x86_64)
    ARCH_X86=1
    ;;

  *)
    echo "Unknown architecture."
	exit 1
	;;
esac

## Install Xcode tools

if [ -n "$OS_MAC" ]; then
		if [ -z "$(xcode-select -p)" ]; then
				echo "INFO: Install developer tools."

				xcode-select --install
		fi
fi

## Install Brew

echo "INFO: Install brew."

if [ -n "$OS_MAC" ]; then
		echo "INFO: Install brew on MacOS."

		if [ -z "$(which brew)" ]; then
				/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

				if [ -n "$ARCH_ARM" ]; then
						echo "INFO: Invoke brew shellenv (M1)."

						eval "$(/opt/homebrew/bin/brew shellenv)"
				elif [ -n "$ARCH_X86" ]; then 
						echo "INFO: Invoke brew shellenv (Intel)."

						eval "$(/usr/local/homebrew/bin/brew shellenv)"
				fi
		fi
fi

if [ -n "$OS_LINUX" ]; then
		echo "INFO: Install linuxbrew on Linux."

		if [ -z "$(which brew)" ]; then
				echo "INFO: Install brew."

				/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
				eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

				sudo apt install build-essential
		fi

		if [ -z "$(which gcc)" ]; then
				echo "INFO: (brew) Install gcc."

				brew install gcc
		fi
fi

## Install Ansible

if [ -z "$(which ansible)" ]; then
		echo "INFO: (brew) Install ansible."
		brew install ansible
fi

# # Manual installs

# ## neovim
# if [ -z "$(which nvim)" ]; then
# 		echo "INFO: Install neovim."

# 		if [ -n "$OS_LINUX" ]; then
# 				cd $HOME/.local/artifacts

# 				curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
# 				chmod u+x nvim.appimage
# 				./nvim.appimage --appimage-extract
# 				mv squashfs-root $HOME/.local/lib/squashfs-nvim
# 				ln -sf $HOME/.local/lib/squashfs-nvim/AppRun $HOME/.local/bin/nvim

# 				### install vim-plug
# 				sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
# 						https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'

# 				### install plugins
# 				nvim --headless +PlugInstall +qa

# 				cd $WORKING_DIR
# 		elif [ -n "$OS_MAC" ]; then
# 				brew install nvim

# 				### install vim-plug
# 				sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
# 						https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'

# 				### install plugins
# 				nvim --headless +PlugInstall +qa
# 		fi
# fi

# # Install TUI apps

# if [ -z $CODESPACES ]; then

# 		## imwheel
# 		if [ -z "$(which imwheel)" ] && [ -n "$OS_LINUX" ]; then
# 				echo "INFO: Install imwheel."

# 				sudo apt install -y imwheel
# 		fi

# 		## Java
# 		if [ -z "$(which javac)" ]; then
# 				echo "INFO: Install javac."

# 				if [ -n "$OS_LINUX" ]; then
# 						sudo apt install -y openjdk-11-jdk
# 						sudo apt install -y openjdk-16-jdk
# 				elif [ -n "$OS_MAC" ]; then
# 						brew install openjdk@11
# 						brew install openjdk
# 				fi
# 		fi

# 		if [ -z "$(which jdtls)" ]; then
# 				echo "INFO: Install eclipse.jdt.ls."

# 				wget https://download.eclipse.org/jdtls/milestones/1.9.0/jdt-language-server-1.9.0-202203031534.tar.gz \
# 						-P $HOME/.local/artifacts

# 				rm -rf $HOME/.local/lib/jdt-language-server
# 				mkdir $HOME/.local/lib/jdt-language-server

# 				tar -xzf $HOME/.local/artifacts/jdt-language-server-1.9.0-202203031534.tar.gz \
# 						-C $HOME/.local/lib/jdt-language-server

# 				ln -sf $HOME/.local/lib/jdt-language-server/bin/jdtls $HOME/.local/bin/jdtls
# 		fi

# 		if [ -z "$(which gradle)" ]; then
# 				echo "INFO: Install gradle."

# 				wget https://services.gradle.org/distributions/gradle-7.4.1-bin.zip -P $HOME/.local/artifacts

# 				unzip -d $HOME/.local/lib/gradle $HOME/.local/artifacts/gradle-*.zip
# 		fi

# 		if [ -z "$(find $HOME/.local/lib/java-debug -type d -name 'com.microsoft.java.debug.core')" ]; then
# 				echo "INFO: Install java-debug."

# 				git clone https://github.com/microsoft/java-debug $HOME/.local/src/java-debug

# 				cd $HOME/.local/src/java-debug
# 				if [ -n $OS_LINUX ]; then
# 						JAVA_HOME="$JAVA_11_HOME/Contents/Home" ./mvnw clean install
# 				elif [ -n $OS_MAC ]; then
# 						JAVA_HOME="$JAVA_11_HOME/Contents/Home" ./mvnw clean install
# 				fi

# 				rm -rf $HOME/.local/lib/java-debug
# 				mkdir $HOME/.local/lib/java-debug
# 				cp -r com.microsoft.java.debug* $HOME/.local/lib/java-debug

# 				cd $WORKING_DIR
# 		fi

# 		# if [ -z "$(find $HOME/.local/lib -type d -iname '*vscode-java-test*')" ]; then
# 		# 		echo "INFO: Install vscode-java-test."

# 		# 		git clone https://github.com/microsoft/vscode-java-test $HOME/.local/src/vscode-java-test

# 		# 		cd $HOME/.local/src/vscode-java-test

# 		# 		npm install
# 		# 		JAVA_HOME=$JAVA_11_HOME npm run build-plugin

# 		# 		rm -rf $HOME/.local/lib/vscode-java-test
# 		# 		mkdir $HOME/.local/lib/vscode-java-test
# 		# 		cp -r $HOME/.local/src/vscode-java-test/* $HOME/.local/lib/vscode-java-test

# 		# 		cd $WORKING_DIR
# 		# fi

# fi


# TODOs
# - [ ] Automate neovim install
# - [ ] Automate java vim install(s)
# - [ ] Discover/document osx config via .osx from dude's repo
# - [ ] Automate setup of osx config
# - [ ] Automate setup of Karabiner Elements
# - [ ] Install dasht + vim-dasht
# - [ ] Install obsidian.vim
